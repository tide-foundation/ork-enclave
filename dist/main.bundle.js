(()=>{"use strict";async function t(t){const r="string"==typeof t?(new TextEncoder).encode(t):t,e=await crypto.subtle.digest("SHA-256",r);return new Uint8Array(e)}async function r(t){const r="string"==typeof t?(new TextEncoder).encode(t):t,e=await crypto.subtle.digest("SHA-512",r);return new Uint8Array(e)}const e=BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989"),n=BigInt(0),i=BigInt(1),a=BigInt(2);function s(t,r=e){var n=t%r;return n>=BigInt(0)?n:r+n}function o(t,r=e){if(t===n||r<=n)throw new Error(`invert: expected positive integers, got n=${t} mod=${r}`);let a=s(t,r),o=r,c=n,l=i,u=i,h=n;for(;a!==n;){const t=o/a,r=o%a,e=c-u*t,n=l-h*t;o=a,a=r,c=u,l=h,u=e,h=n}if(o!==i)throw new Error("invert: does not exist");return s(c,r)}function c(){const t=new Uint8Array(32);return window.crypto.getRandomValues(t),s(u(t),e)}function l(t){return function(t){const r=t.length%2?"0"+t:t,e=new Uint8Array(r.length/2);for(let t=0;t<e.length;++t){const n=r.charCodeAt(2*t),i=r.charCodeAt(2*t+1),a=n-(n<58?48:87),s=i-(i<58?48:87);e[t]=16*a+s}return e}(t.toString(16).padStart(64,"0")).reverse()}function u(t){const r=p(t.reverse());return BigInt("0x"+r)}function h(t){const r=t.reduce(((t,r)=>r.length+t),0);var e=new Uint8Array(r),n=0;return t.forEach((t=>{e.set(t,n),n+=t.length})),e}function d(t,r){if(t.length!==r.length)throw new Error("Arrays have different lengths, cannot XOR them.");let e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t[n]^r[n];return e}function w(t){return(new TextEncoder).encode(t)}function m(t){return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}function g(t){let r=t.replace(/-/g,"+").replace(/_/g,"/");for(;r.length%4;)r+="=";return r}function p(t){const r=new Uint8Array(2*t.length),e="a".charCodeAt(0)-10,n="0".charCodeAt(0);let i=0;for(let a=0;a<t.length;a++){let s=t[a]>>>4;r[i++]=s>9?s+e:s+n,s=15&t[a],r[i++]=s>9?s+e:s+n}return String.fromCharCode.apply(null,r)}const f=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],y=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,62,255,255,255,63,52,53,54,55,56,57,58,59,60,61,255,255,255,0,255,255,255,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,255,255,255,255,255,255,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];function S(t){if(t>=y.length)throw new Error("Unable to parse base64 string.");const r=y[t];if(255===r)throw new Error("Unable to parse base64 string.");return r}function C(t){let r,e="",n=t.length;for(r=2;r<n;r+=3)e+=f[t[r-2]>>2],e+=f[(3&t[r-2])<<4|t[r-1]>>4],e+=f[(15&t[r-1])<<2|t[r]>>6],e+=f[63&t[r]];return r===n+1&&(e+=f[t[r-2]>>2],e+=f[(3&t[r-2])<<4],e+="=="),r===n&&(e+=f[t[r-2]>>2],e+=f[(3&t[r-2])<<4|t[r-1]>>4],e+=f[(15&t[r-1])<<2],e+="="),e}function v(t){if(t.length%4!=0)throw new Error("Unable to parse base64 string.");const r=t.indexOf("=");if(-1!==r&&r<t.length-2)throw new Error("Unable to parse base64 string.");let e,n=t.endsWith("==")?2:t.endsWith("=")?1:0,i=t.length,a=new Uint8Array(i/4*3);for(let r=0,n=0;r<i;r+=4,n+=3)e=S(t.charCodeAt(r))<<18|S(t.charCodeAt(r+1))<<12|S(t.charCodeAt(r+2))<<6|S(t.charCodeAt(r+3)),a[n]=e>>16,a[n+1]=e>>8&255,a[n+2]=255&e;return a.subarray(0,a.length-n)}function I(t){const r=Array.from(t).sort(),e=Math.floor(r.length/2);return r.length%2==0?(r[e-1]+r[e])/a:r[e]}const B=BigInt(0),K=BigInt(1),A=BigInt(2);class k{static get a(){return BigInt(-1)}static get d(){return BigInt("37095705934669439343138083508754565189542113879843219016388785533085940283555")}static get d_FOR_Y_FROM_X(){return BigInt("20800338683988658368647408995589388737092878452977063003340006470870624536394")}static get p(){return BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949")}static get order(){return BigInt("7237005577332262213973186563042994240857116359379907606001950938285454250989")}static get g(){return new k(BigInt("15112221349535400772501151409588531511454012693041857206046113283949847762202"),BigInt("46316835694926478169428394003475163141307993866256225615783033603165251855960"),K,BigInt("46827403850823179245072216630277197565144205554125654976674165829533817101731"))}static get infinity(){return new k(B,K,K,B)}static get SQRT_M1(){return BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752")}constructor(t,r=null,e=null,n=null){this.x=t,this.y=null!==r?r:function(t){var r=b(t*t);return U(b(K+r),b(K+k.d_FOR_Y_FROM_X*r)).value}(t),this.z=null!==e?e:K,this.t=null!==n?n:b(this.x*this.y)}isInfinity(){return this.isEqual(k.infinity)}isEqual(t){const r=b(this.x*t.z),e=b(t.x*this.z),n=b(this.y*t.z),i=b(t.y*this.z);return r===e&&n===i}negate(){return new k(b(-this.x),this.y,this.z,b(-this.t))}times(t){var r=new k(this.x,this.y,this.z,this.t);let e=k.infinity;for(;t>B;)(t&K)===K&&(e=e.add(r)),r=r.double(),t>>=K;return e}double(){let t=b(this.x*this.x),r=b(this.y*this.y),e=b(A*b(this.z*this.z)),n=b(k.a*t),i=this.x+this.y,a=b(b(i*i)-t-r),s=n+r,o=s-e,c=n-r,l=b(a*o),u=b(s*c),h=b(a*c),d=b(o*s);return new k(l,u,d,h)}add(t){let r=b((this.y-this.x)*(t.y+t.x)),e=b((this.y+this.x)*(t.y-t.x)),n=b(e-r);if(n==B)return this.double();let i=b(this.z*A*t.t),a=b(this.t*A*t.z),s=a+i,o=e+r,c=a-i,l=b(s*n),u=b(o*c),h=b(s*c),d=b(n*o);return new k(l,u,d,h)}getX(){return b(this.x*E(this.z))}getY(){return b(this.y*E(this.z))}static from(t){return this.decompress(t)}static fromB64(t){return null==t?null:this.decompress(v(t))}toArray(){return this.compress()}toBase64(){return C(this.toArray())}compress(){const t=l(this.getY());return t[31]|=this.getX()&K?128:0,t}static decompress(t){const r=t.slice();r[31]=-129&t[31];const e=u(r);if(e>=k.p)throw new Error("Decompress: Expected 0 < hex < P");const n=b(e*e),i=b(n-K),a=b(k.d*n+K);let{isValid:s,value:o}=U(i,a);if(!s)throw new Error("Decompress: invalid y coordinate");const c=(o&K)===K;return 0!=(128&t[31])!==c&&(o=b(-o)),new k(o,e)}}function b(t,r=k.p){var e=t%r;return e>=B?e:r+e}function E(t,r=k.p){if(t===B||r<=B)throw new Error(`invert: expected positive integers, got n=${t} mod=${r}`);let e=b(t,r),n=r,i=B,a=K,s=K,o=B;for(;e!==B;){const t=n/e,r=n%e,c=i-s*t,l=a-o*t;n=e,e=r,i=s,a=o,s=c,o=l}if(n!==K)throw new Error("invert: does not exist");return b(i,r)}function _(t,r){for(;r-- >B;)t=b(t*t);return t}function U(t,r){const e=b(r*r*r),n=function(t){const r=k.p,e=BigInt(5),n=BigInt(10),i=BigInt(20),a=BigInt(40),s=BigInt(80),o=t*t%r*t%r,c=_(o,A)*o%r,l=_(c,K)*t%r,u=_(l,e)*l%r,h=_(u,n)*u%r,d=_(h,i)*h%r,w=_(d,a)*d%r,m=_(w,s)*w%r,g=_(m,s)*w%r,p=_(g,n)*u%r;return{pow_p_5_8:_(p,A)*t%r,b2:o}}(t*b(e*e*r)).pow_p_5_8;let i=b(t*e*n);const a=b(r*i*i),s=i,o=b(i*k.SQRT_M1),c=a===t,l=a===b(-t),u=a===b(-t*k.SQRT_M1);return c&&(i=s),(l||u)&&(i=o),(b(i)&K)===K&&(i=b(-i)),{isValid:c||l,value:i}}class M{constructor(t,r,e,n,i){this.YijCiphers=t,this.GRi=r,this.Timestampi=e,this.GMultiplied=n,this.GK1i=i}static from(t){const r=JSON.parse(t),e=BigInt(r.Timestampi),n=k.fromB64(r.GRi),i=r.GMultiplied.map((t=>null==t?null:k.fromB64(t))),a=k.fromB64(r.GK1i);return new M(r.YijCiphers,n,e,i,a)}}class P{constructor(t){this.url=t}_createFormData(t){const r=new FormData;return Object.entries(t).forEach((([t,e])=>{if(Array.isArray(e))for(let n=0;n<e.length;n++)r.append(t+"["+n+"]",e[n]);else r.append(t,e)})),r}async _get(t,r=2e4){const e=new AbortController,n=setTimeout((()=>e.abort()),r),i=await fetch(this.url+t,{method:"GET",signal:e.signal});return clearTimeout(n),i}async _post(t,r,e=2e4){const n=new AbortController,i=setTimeout((()=>n.abort()),e),a=fetch(this.url+t,{method:"POST",body:r,signal:n.signal});return clearTimeout(i),a}async _put(t,r){return fetch(this.url+t,{method:"PUT",body:r})}async _postJSON(t,r){return fetch(this.url+t,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(r)})}async _handleError(t,r){var e="";t.ok||(e="ORK did not return status OK");const n=await t.text();return"--FAILED--"===n.split(":")[0]&&(e=""===n.split(":")[1]?`Tide Protocol Error: ${r} Failed`:n.split(":")[1]),""!==e?Promise.reject(e):n}async _handleErrorSimulator(t){var r="";const e=await t.text();return t.ok||(r=e),""!==r?Promise.reject(r):e}}class O{constructor(t){this.Si=t}static from(t){const r=u(v(JSON.parse(t).Si));return new O(r)}}class V{constructor(t,r,e){this.EncryptedData=t,this.GBlurPassPRISMi=r,this.Timestampi=e}static from(t){const r=JSON.parse(t),e=BigInt(r.Timestampi),n=k.fromB64(r.GBlurPassPrism);return new V(r.EncryptedData,n,e)}}class x extends P{constructor(t){super(t)}async Convert(t,r,e,n=!1){const i=this._createFormData({gBlurUser:r.toBase64(),gBlurPass:e.toBase64(),test:n}),a=await this._post(`/CMK/Convert?uid=${t}`,i),s=await this._handleError(a,"Convert CMK/Prism");return V.from(s)}async Authenticate(t,r,e,n=!1){const i=this._createFormData({decryptedChallenge:r,encAuthRequest:e,test:n}),a=await this._post(`/CMK/Authenticate?uid=${t}`,i);return await this._handleError(a,"Authenticate")}async PreSignInCVK(t,r){const e=this._createFormData({gSessKeyPub:r.toBase64()}),n=await this._post(`/CVK/PreSignIn?uid=${t}`,e);return await this._handleError(n,"PreSignInCVK")}async SignInCVK(t,r,e,n,i,a,s,o,c=!1){const l=this._createFormData({jwt:r,timestamp2:e.toString(),gRMul:n.toBase64(),s:i.toString(),gCVKR:a.toBase64(),li:s.toString(),gBlindH:o.toBase64(),test:c}),u=await this._post(`/CVK/SignIn?uid=${t}`,l);return await this._handleError(u,"SignInCVK")}async GenShard(t,r,e,n){const i=this._createFormData({mIdORKij:r.map((t=>t.toString())),numKeys:e,gMultipliers:n.map((t=>null==t?"":t.toBase64()))}),a=await this._post(`/Create/GenShard?uid=${t}`,i),s=await this._handleError(a,"GenShard");return M.from(s)}async SendShard(t,r,e,n,i){const a=this._createFormData({yijCipher:r,R2:e.toBase64(),auth:n.toBase64(),keyType:i}),s=await this._post(`/Create/SendShard?uid=${t}`,a),o=await this._handleError(s,"SendShard");return O.from(o)}async Commit(t,r,e){const n=this._createFormData({S:r.toString(),keyType:e}),i=await this._post(`/Create/Commit?uid=${t}`,n);"Account Created"!==await this._handleError(i,"Commit")&&Promise.reject("Commit: Accound creation failed")}}new TextEncoder;const R=new TextDecoder;function T(t,r){return window.crypto.subtle.importKey("raw",t,"AES-GCM",!0,r)}async function D(t,r){var e;r instanceof Uint8Array?e=await T(r,["encrypt"]):r instanceof CryptoKey?e=r:"string"==typeof r?e=await T((new TextEncoder).encode(r),["encrypt"]):"bigint"==typeof r&&(e=await T(l(r),["encrypt"]));const n="string"==typeof t?(new TextEncoder).encode(t):t,i=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},e,n);return C(h([i,new Uint8Array(a)]))}async function G(t,r){var e;r instanceof Uint8Array?e=await T(r,["decrypt"]):r instanceof CryptoKey?e=r:"string"==typeof r?e=await T((new TextEncoder).encode(r),["decrypt"]):"bigint"==typeof r&&(e=await T(l(r),["decrypt"]));const n=v(t),i=n.slice(0,12),a=n.slice(12),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:i},e,a);return R.decode(s)}function j(t,r,e){return r.filter((r=>r!=t)).map((r=>s(o(r-t,e)*r)),e).reduce(((t,r)=>s(t*r,e)))}class F{constructor(t){this.orks=t}async GenShard(t,r,e){const n=this.orks.map((t=>new x(t[1]))),i=this.orks.map((t=>BigInt(t[0]))),a=n.map((n=>n.GenShard(t,i,r,e))),s=await Promise.all(a);return{sortedShares:(c=(o=s).map((t=>t.YijCiphers))).map(((t,r)=>c.map((t=>t[r])))),timestamp:I(o.map((t=>t.Timestampi))),R2:o.reduce(((t,r)=>r.GRi.add(t)),k.infinity),gMultiplied:o[0].GMultiplied.map(((t,r)=>null==t?null:o.reduce(((t,e)=>t.add(e.GMultiplied[r])),k.infinity))),gK1:o.reduce(((t,r)=>t.add(r.GK1i)),k.infinity)};var o,c}async SendShard(e,n,i,a,o,c,l){const d=this.orks.map((t=>new x(t[1]))).map(((t,r)=>t.SendShard(e,n[r],i,o,c))),m=await Promise.all(d);return async function(e,n,i,a,o,c){const l=s(n.reduce(((t,r)=>r.Si+t),BigInt(0))),d=h([c.compress(),w(a.toString()),w(e)]),m=await t(d),g=i.reduce(((t,r)=>t.add(r))).add(o),p=h([g.compress(),c.compress(),m]),f=s(u(await r(p)),k.order);if(!k.g.times(l).isEqual(g.add(c.times(f))))throw new Error("SendShard: Signature test failed");return{S:l}}(e,m,this.orks.map((t=>t[2])),a,i,l)}async Commit(t,r,e){const n=this.orks.map((t=>new x(t[1]))).map((n=>n.Commit(t,r,e)));await Promise.all(n)}}class N extends P{constructor(t){super(t)}async GetAllORKs(){const t=await this._get("/orks");return JSON.parse(await t.text()).map((t=>[t.orkId,t.orkName,t.orkUrl,t.orkPub]))}async GetUserORKs(t){const r=await this._get(`keyentry/orks/${t}`),e=await this._handleErrorSimulator(r),n=JSON.parse(e);return n.orkPubs.map((t=>k.fromB64(t))).map(((t,r)=>[n.orkIds[r],n.orkUrls[r],t]))}async GetKeyPublic(t){const r=await this._get(`keyentry/${t}`),e=await this._handleErrorSimulator(r),n=JSON.parse(e);return k.fromB64(n.public)}async GetActiveORKs(){const t=await this._get("/orks/active");return JSON.parse(await t.text()).map((t=>[t.orkId,t.orkName,t.orkUrl,t.orkPub]))}}class ${constructor(t){if(!Object.hasOwn(t,"urls"))throw Error("Urls has not been included in config");this.urls=t.urls}async getActiveOrks(){const t=this.urls.map((t=>new N(t))).map((t=>t.GetActiveORKs()));return(await Promise.all(t))[0]}}class z{constructor(t,r){this.Si=t,this.gBlindH=r}static from(t){const r=JSON.parse(t),e=BigInt(r.Si),n=k.fromB64(r.gBlindHi);return new z(e,n)}}class H{constructor(t,r,e){this.Challengei=t,this.GBlurUserCMKi=r,this.GCMKRi=e}static from(t){const r=JSON.parse(t),e=k.fromB64(r.GBlurUserCMKi),n=k.fromB64(r.GCMKRi);return new H(r.Challengei,e,n)}}class J{static new(t,r,e,n){const i={uid:t,exp:Math.floor(Date.now()/1e3)+60*r,gSessKeyPub:e.toBase64(),gVVK:n};return m(C(w(JSON.stringify({alg:"EdDSA",typ:"JWT"}))))+"."+m(C(w(JSON.stringify(i))))}static getUID(t){var r=t.split(".")[1];return JSON.parse(atob(g(r))).uid}static addSignature(t,r,e){return t+"."+m(C(h([e.toArray(),l(r)])))}static async verify(t,r){const e=t.split("."),n=w(e[0]+"."+e[1]),i=g(e[2]);return await ft(i,r,n)}}async function L(r,e,n,i){const a=r.map((async(t,r)=>z.from(await G(t,n.prismAuthis[r])))),c=await Promise.all(a),l=o(n.r4),h=s(c.reduce(((t,r)=>t+r.Si),BigInt(0))*l),d=c.reduce(((t,r)=>t.add(r.gBlindH)),k.infinity).times(l),w=BigInt(8),m=s(u(await t("CMK authentication")));if(!k.g.times(h).times(w).isEqual(n.gRMul.times(w).add(n.gCMKAuth.times(n.H).times(w)).add(d.times(m).times(w))))throw new Error("Blind signature failed");const g=i.map((async r=>await t(r.times(n.SessKey).toArray()))),p=await Promise.all(g),f=e.map((async(t,r)=>k.fromB64(await G(t,p[r]))));return{gCVKR:(await Promise.all(f)).reduce(((t,r)=>t.add(r))),S:h,ECDHi:p,gBlindH:d}}class q{constructor(t){this.CMKorks=t,this.threshold=2}async Convert(e,n,i,a,d,w,m,g,f=!1){const y=this.CMKorks.map((t=>new x(t[1]))).map((t=>t.Convert(e,n,i,f))),S=await Promise.allSettled(y);var v=[];if(S.forEach(((t,r)=>{"fulfilled"===t.status&&v.push(this.CMKorks[r])})),v.length<this.threshold)throw S.filter((t=>"rejected"===t.status)).some((t=>"Too many attempts"===t.reason))?new Error("Too many attempts"):new Error("CMK Orks for this account are down");this.CMKorks=v;const B=this.CMKorks.map((t=>BigInt(t[0]))),K=B.map((t=>j(t,B,k.order))),A=S.filter((t=>"fulfilled"===t.status)).map((t=>t.value)),{prismAuthis:b,deltaTime:E}=await async function(r,e,n,i,a){const c=r.reduce(((t,r,n)=>t.add(r.GBlurPassPRISMi.times(e[n]))),k.infinity).times(o(i)),l=s(u(await t(c.toArray()))),h=n.map((async r=>await t(r.times(l).toArray())));return{prismAuthis:await Promise.all(h),deltaTime:I(r.map((t=>t.Timestampi)))-a}}(A,K,this.CMKorks.map((t=>t[2])),a,w);return await async function(e,n,i,a,d,w,m,g){const f=n.map((async(t,r)=>H.from(await G(t.EncryptedData,a[r])))),y=await Promise.all(f),S=y.reduce(((t,r,e)=>t.add(r.GBlurUserCMKi.times(i[e]))),k.infinity).times(o(w)),v=await r(S.toArray()),I=s(u(v.slice(0,32))),B=p(v.slice(-32)),K=d.times(I),A=c(),b=k.g.times(A),E=c(),_=y.reduce(((t,r)=>t.add(r.GCMKRi)),k.infinity).times(o(E)),U=BigInt(Math.floor(Date.now()/1e3))+m,M=await t(U.toString()+b.toBase64()),P=s(u(await r(h([_.toArray(),K.toArray(),M])))),O=i.map((t=>s(P*I*E*t))),V=a.map((async(t,r)=>await D(JSON.stringify({UserId:e,BlurHCMKMuli:C(l(O[r]))}),t)));return{VUID:B,encAuthRequests:await Promise.all(V),timestamp2:U,jwt:J.new(B,30,b,g),gSessKeyPub:b,data_for_PreSignInCVK:{prismAuthis:a,r4:E,gRMul:_,H:P,gCMKAuth:K,SessKey:A},decChallengei:y.map((t=>t.Challengei))}}(e,A,K,b,m,d,E,g)}async Authenticate_and_PreSignInCVK(t,r,e,n,i,a,s=!1){const o=this.CMKorks.map((t=>new x(t[1]))),c=this.CVKorks.map((t=>new x(t[1]))),l=o.map(((r,i)=>r.Authenticate(t,e[i],n[i],s))),u=c.map((t=>t.PreSignInCVK(r,i))),h=await Promise.all(l),d=await Promise.allSettled(u);var w=[];if(d.forEach(((t,r)=>{"fulfilled"===t.status&&w.push(this.CVKorks[r])})),w.length<this.threshold)throw d.filter((t=>"rejected"===t.status)).some((t=>"Too many attempts"===t.reason))?new Error("Too many attempts"):new Error("CVK Orks for this account are down");this.CVKorks=w;const m=this.CVKorks.map((t=>BigInt(t[0]))),g=m.map((t=>j(t,m,k.order))),p=d.filter((t=>"fulfilled"===t.status)).map((t=>t.value));return{...await L(h,p,a,this.CVKorks.map((t=>t[2]))),vlis:g}}async SignInCVK(t,r,e,n,i,a,o,c,l,u=!1){const h=this.CVKorks.map((t=>new x(t[1]))).map(((s,c)=>s.SignInCVK(t,r,n,i,o,a,e[c],l,u))),d=await Promise.all(h);return await async function(t,r,e,n,i){const a=t.map((async(t,r)=>BigInt(await G(t,n[r])))),o=s((await Promise.all(a)).reduce(((t,r,e)=>t+r*i[e]),BigInt(0)));return J.addSignature(e,o,r)}(d,a,r,c,e)}}const X=BigInt(0),Y=BigInt(1),Q=BigInt(2);function W(t,r,e){return e?r:t}function Z(t,r,e=k.p){return s(t+r,e)}function tt(t,r,e=k.p){return s(BigInt(t*r),e)}function rt(t,r,e=k.p){if(r<X)throw new Error("Expected power > 0");if(r===X)return Y;if(r===Y)return t;let n=Y,i=t;for(;r>X;)r&Y&&(n=tt(n,i,e)),i=tt(i,i,e),r>>=Y;return n}const et=BigInt("6853475219497561581579357271197624642482790079785650197046958215289687604742"),nt=(k.p+BigInt(3))/BigInt(8),it=rt(Q,nt),at=BigInt("38214883241950591754978413199355411911188925816896391856984770930832735035197"),st=(k.p-BigInt(5))/BigInt(8),ot=BigInt(486662);function ct(t){const{xMn:r,xMd:e,yMn:n,yMd:i}=function(t){let r=tt(t,t);r=tt(r,Q);let e=Z(r,Y),n=-ot,i=tt(e,e),a=tt(i,e),s=tt(r,ot);s=tt(s,n),s=Z(s,i),s=tt(s,n);let o=tt(a,a);i=tt(o,o),o=tt(o,a),o=tt(o,s),i=tt(i,o);let c=rt(i,st);c=tt(c,o);let l=tt(c,at);i=tt(c,c),i=tt(i,a);let u=W(l,c,i===s),h=tt(n,r),d=tt(c,t);d=tt(d,it);let w=tt(d,at),m=tt(s,r);i=tt(d,d),i=tt(i,a);let g=W(w,d,i===m);i=tt(u,u),i=tt(i,a);let p=i===s,f=W(h,n,p),y=W(g,u,p);return y=W(y,-y,p!==((y&Y)===Y)),{xMn:f,xMd:e,yMn:y,yMd:Y}}(t);let a=tt(r,i);a=tt(a,et);let c=tt(e,n),l=s(r-e,k.p),u=Z(r,e),h=tt(c,u)===X;a=W(a,X,h),c=W(c,Y,h),l=W(l,Y,h),u=W(u,Y,h);const d=function(t){const r=new Array(t.length),e=o(t.reduce(((t,e,n)=>e===X?t:(r[n]=t,tt(t,e))),Y),k.p);return t.reduceRight(((t,e,n)=>e===X?t:(r[n]=tt(t,r[n]),tt(t,e))),e),r}([c,u]);return{x:tt(a,d[0]),y:tt(l,d[1])}}function lt(t,r){if(t<0||t>=1<<8*r)throw new Error(`bad I2OSP call: value=${t} length=${r}`);const e=Array.from({length:r}).fill(0);for(let n=r-1;n>=0;n--)e[n]=255&t,t>>>=8;return new Uint8Array(e)}function ut(t,r){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t[n]^r[n];return e}async function ht(t){let e=(new TextEncoder).encode(t);const n=await async function(t){const e=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949"),n=(new TextEncoder).encode("QUUX-V01-CS02-with-edwards25519_XMD:SHA-512_ELL2_RO_"),i=e.toString(2).length,a=Math.ceil((i+128)/8),o=2*a;let c=await async function(t,e,n){const i=Math.ceil(n/64);if(i>255)throw new Error("Invalid xmd length");const a=h([e,lt(e.length,1)]),s=lt(0,128),o=lt(n,2),c=new Array(i),l=h([s,t,o,lt(0,1),a]),u=await r(l),d=r(h([u,lt(1,1),a]));c[0]=await d;for(let t=1;t<=i;t++){const e=[ut(u,c[t-1]),lt(t+1,1),a];c[t]=await r(h(e))}return h(c).slice(0,n)}(t,n,o);const l=new Array(2);for(let t=0;t<2;t++){const r=new Array(1);for(let n=0;n<1;n++){const i=a*(n+1*t),o=c.subarray(i,i+a);r[n]=s(u(o.reverse()),e)}l[t]=r}return l}(e),i=ct(n[0][0]),a=ct(n[1][0]),o=new k(i.x,i.y),c=new k(a.x,a.y);return o.add(c).times(BigInt("8"))}class dt{constructor(t){if(!Object.hasOwn(t,"simulatorUrl"))throw Error("Simulator Url has not been included in config");this.simulatorUrl=t.simulatorUrl}async start(r,e,n){const i=BigInt(Math.floor(Date.now()/1e3)),a=c(),s=c(),o=p(await t(r.toLowerCase())),l=new N(this.simulatorUrl),u=l.GetUserORKs(o),h=l.GetKeyPublic(o),d=(await ht(r.toLowerCase()+n)).times(s),w=(await ht(e)).times(a),m=await u,g=await h,f=new q(m),y=await f.Convert(o,d,w,a,s,i,g,n),S=await l.GetUserORKs(y.VUID);f.CVKorks=S;const C=await f.Authenticate_and_PreSignInCVK(o,y.VUID,y.decChallengei,y.encAuthRequests,y.gSessKeyPub,y.data_for_PreSignInCVK);return await f.SignInCVK(y.VUID,y.jwt,C.vlis,y.timestamp2,y.data_for_PreSignInCVK.gRMul,C.gCVKR,C.S,C.ECDHi,C.gBlindH)}}class wt extends P{constructor(t){super(t)}async DecryptionTest(t,r,e,n){const i=this._createFormData({encryptedByGCVK:t,encryptedByGVVK:r,jwt:e,cvkOrkUrl:n}),a=await this._post("tide/decryptiontest",i);if("Test Passed"!==await this._handleError(a,"Decryption Test"))throw Error("Decryption Test: Failed")}}class mt{static async encryptData(r,e){const n=c(),i=k.g.times(n).toArray();var a;if(r.length<=32){const i=function(t,r,e=0){for(;t.length<r;)t.push(e);return t}(r,32),s=new Uint8Array([r.length]);a=h([new Uint8Array([0]),s,d(i,await t(e.times(n).toArray()))])}else a=v(await D(r,await t(e.times(n).toArray())));return C(h([i,a]))}}class gt{constructor(t,r,e,n,i){this.vendorUrl=t,this.vendorPublic=r,this.userPublic=e,this.jwt=n,this.cvkOrkUrl=i}async startTest(){const t=new Uint8Array(32);window.crypto.getRandomValues(t);const r=await mt.encryptData(t,this.userPublic),e=await mt.encryptData(t,this.vendorPublic),n=new wt(this.vendorUrl);await n.DecryptionTest(r,e,this.jwt,this.cvkOrkUrl)}}class pt{constructor(t){if(!Object.hasOwn(t,"cmkOrkInfo"))throw Error("CMK OrkInfo has not been included in config");if(!Object.hasOwn(t,"cvkOrkInfo"))throw Error("CVK OrkInfo has not been included in config");if(!Object.hasOwn(t,"simulatorUrl"))throw Error("Simulator Url has not been included in config");this.cmkOrkInfo=t.cmkOrkInfo,this.cvkOrkInfo=t.cvkOrkInfo,this.simulatorUrl=t.simulatorUrl}async start(r,e,n,i){const a=p(await t(r.toLowerCase())),s=c(),o=c(),l=await ht(r.toLowerCase()+n),u=l.times(s),h=await ht(e),d=h.times(o),w=new F(this.cmkOrkInfo),m=await w.GenShard(a,2,[u,d]),{gPRISMAuth:g,VUID:f,gCMKAuth:y}=await this.getKeyPoints(m.gMultiplied,[s,o],m.gK1),S=w.SendShard(a,m.sortedShares,m.R2,m.timestamp,g,"CMK",m.gK1),C=new F(this.cvkOrkInfo),v=await C.GenShard(f,1,[]),I=await C.SendShard(f,v.sortedShares,v.R2,v.timestamp,y,"CVK",v.gK1),B=await S,K=await this.testSignIn(a,l,h,n,m.gK1,v.gK1),A=new gt(i,k.fromB64(n),v.gK1,K,this.cvkOrkInfo[0][1]);await A.startTest();const b=w.Commit(a,B.S,"CMK"),E=C.Commit(f,I.S,"CVK");return await b,await E,K}async testSignIn(t,r,e,n,i,a){const s=BigInt(Math.floor(Date.now()/1e3)),o=c(),l=c(),u=r.times(l),h=e.times(o),d=new q(this.cmkOrkInfo),w=await d.Convert(t,u,h,o,l,s,i,n,!0);d.CVKorks=this.cvkOrkInfo;const m=await d.Authenticate_and_PreSignInCVK(t,w.VUID,w.decChallengei,w.encAuthRequests,w.gSessKeyPub,w.data_for_PreSignInCVK,!0),g=await d.SignInCVK(w.VUID,w.jwt,m.vlis,w.timestamp2,w.data_for_PreSignInCVK.gRMul,m.gCVKR,m.S,m.ECDHi,m.gBlindH,!0);if(!await J.verify(g,a))throw Error("Test sign in failed");return g}async getKeyPoints(e,n,i){const a=e[0].times(o(n[0])),c=e[1].times(o(n[1])),l=k.g.times(u(await t(c.toArray()))),h=await r(a.toArray()),d=p(h.slice(-32)),w=s(u(h.slice(0,32)));return{VUID:d,gCMKAuth:i.times(w),gPRISMAuth:l}}}async function ft(t,e,n){try{"string"==typeof n&&(n=w(n));const i=v(t);if(64!=i.length)return!1;const a=k.from(i.slice(0,32)),o=u(i.slice(-32));if(o<=BigInt(0)||o>=k.order)return!1;"string"==typeof e&&(e=k.fromB64(e));const c=h([a.toArray(),e.toArray(),n]),l=s(u(await r(c)));return k.g.times(o).times(BigInt(8)).isEqual(a.times(BigInt(8)).add(e.times(l).times(BigInt(8))))}catch{return!1}}var yt=[];!function(t){function r(r){if("email"==t(r).attr("type")||"email"==t(r).attr("name")){if(null==t(r).val().trim().match(/^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{1,5}|[0-9]{1,3})(\]?)$/))return!1}else if(""==t(r).val().trim())return!1}function e(r){var e=t(r).parent();t(e).addClass("alert-validate")}function n(r){var e=t(r).parent();t(e).removeClass("alert-validate")}window.onload=async function(){const r=new $({urls:["http://host.docker.internal:2000"]});yt=await r.getActiveOrks();for(var e=document.getElementById("ork-drop-down"),n=0;n<yt.length;n++){var i=yt[n],a=document.createElement("option");a.textContent=i[1],a.value=i,e.add(a)}t("#orkloader").hide(),yt.length<=0&&(t("#alert-su").text("There is no orks found !"),t("#alert-su").show())}(),t("#loader").hide(),t(".input100").each((function(){t(this).on("blur",(function(){""!=t(this).val().trim()?t(this).addClass("has-val"):t(this).removeClass("has-val")}))})),t(".validate-form-si").on("submit",(function(){var n=t(".validate-input-si .input100");t("#submit-btn-si").prop("disabled",!0);for(var i=!0,a=0;a<n.length;a++)0==r(n[a])&&(e(n[a]),i=!1);return i?async function(r,e){t("#loader").show();const n=new URLSearchParams(window.location.search);var i=new dt({simulatorUrl:"http://host.docker.internal:2000/"});try{if(!await ft(n.get("vendorUrlSig"),n.get("vendorPublic"),n.get("vendorUrl")))throw Error("Vendor URL sig is invalid");const t=await i.start(r,e,n.get("vendorPublic"));window.opener.postMessage(t,n.get("vendorUrl")),window.self.close()}catch(r){t("#alert-si").text(r),t("#alert-si").show(),t("#submit-btn-si").prop("disabled",!1),t("#loader").hide()}}(n[0].value,n[1].value):t("#submit-btn-si").prop("disabled",!1),!1})),t(".validate-form-su").on("submit",(function(){var n=t(".validate-input-su .input100");t("#submit-btn-su").prop("disabled",!0);for(var i=!0,a=0;a<n.length;a++)0==r(n[a])&&(e(n[a]),i=!1);n[1].value!=n[2].value&&(i=!1,e(n[2]));var s=t("#ork-drop-down").val();return s.length<5&&"localhost"!=window.location.hostname&&(i=!1,e("#ork-drop-down")),i?async function(r,e,n){t("#loader-su").show();var i=[];n.forEach((t=>{const r=t.split(",");i.push([r[0],r[2],k.fromB64(r[3])])}));var a=yt.sort((()=>.5-Math.random())).slice(0,5).map((t=>[t[0],t[2],k.fromB64(t[3])])),s={cmkOrkInfo:i,cvkOrkInfo:a,simulatorUrl:"http://host.docker.internal:2000/"};const o=new URLSearchParams(window.location.search);var c=new pt(s);try{if(!await ft(o.get("vendorUrlSig"),o.get("vendorPublic"),o.get("vendorUrl")))throw Error("Vendor URL sig is invalid");const t=await c.start(r,e,o.get("vendorPublic"),o.get("vendorUrl"));window.opener.postMessage(t,o.get("vendorUrl")),window.self.close()}catch(r){t("#alert-su").text(r),t("#alert-su").show(),t("#submit-btn-su").prop("disabled",!1),t("#loader-su").hide()}}(n[0].value,n[1].value,s):t("#submit-btn-su").prop("disabled",!1),!1})),t("#ork-drop-down").change((function(){n(this)})),t(".validate-form-si .input100").each((function(){t(this).focus((function(){n(this)}))}))}(jQuery)})();